sap.ui.define([                                                                                                                                                                                                                                                
		 "com/codilog/controller/BaseController",                                                                                                                                                                                                                    
         "com/codilog/model/formatter",                                                                                                                                                                                                                        
         "sap/m/MessageToast",                                                                                                                                                                                                                                 
         "sap/m/MessageBox"],                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
function (BaseController, formatter, MessageToast, MessageBox) {                                                                                                                                                                                               
  "use strict";                                                                                                                                                                                                                                                
  return BaseController.extend("com.codilog.controller.Root", {                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
    formatter : formatter,                                                                                                                                                                                                                                     
    /**                                                                                                                                                                                                                                                        
  *@memberOf com.codilog.controller.Root                                                                                                                                                                                                                       
  */                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
//    onInit: function () {                                                                                                                                                                                                                                    
//     var dDate = new Date();                                                                                                                                                                                                                                 
//      dDate.setDate(dDate.getDate() + 1);                                                                                                                                                                                                                    
//      this.byId("newDeliveryDateId").setDateValue(dDate);                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
//    },                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
    onAfterRendering: function(){                                                                                                                                                                                                                              
    // Bind the view.                                                                                                                                                                                                                                          
//      var sId = jQuery.sap.getUriParameters().get("wiid");                                                                                                                                                                                                   
//      var sId = jQuery.sap.getUriParameters().get("WI_ID");                                                                                                                                                                                                  
      var sId = this._retrieveWI();                                                                                                                                                                                                                            
      this._bindView(sId);                                                                                                                                                                                                                                     
    },                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
    _bindView: function(sId){                                                                                                                                                                                                                                  
      var oModel = this.getView().getModel();                                                                                                                                                                                                                  
      var bundle = this.getView().getModel("i18n").getResourceBundle();                                                                                                                                                                                        
      var that = this;                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
      var sPath = "/PoItemToReceiptSet('"+sId+"')";                                                                                                                                                                                                            
      oModel.read(sPath,{                                                                                                                                                                                                                                      
              filters: null,                                                                                                                                                                                                                                   
              async: false,                                                                                                                                                                                                                                    
              success:function(oData, oResponse){                                                                                                                                                                                                              
              var cont = that.getView().getModel().getContext(sPath);                                                                                                                                                                                          
             	that.getView().setBindingContext(cont);                                                                                                                                                                                                          
              },                                                                                                                                                                                                                                               
              error:function(oResponse){                                                                                                                                                                                                                       
                  MessageBox.show(                                                                                                                                                                                                                             
            JSON.parse(oResponse.responseText).error.message.value, {                                                                                                                                                                                          
              icon: sap.m.MessageBox.Icon.ERROR,                                                                                                                                                                                                               
              title: bundle.getText("popupError.ErrorTitle")});                                                                                                                                                                                                
//              actions: [sap.m.MessageBox.Action.YES, sap.m.MessageBox.Action.NO],                                                                                                                                                                            
//          onClose: function(oAction) { / * do something * / }                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
//                MessageToast.show(JSON.parse(oResponse.responseText).error.message.value);                                                                                                                                                                   
              }});                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
    },                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
    onDateSave: function () {                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
//      var sWI = jQuery.sap.getUriParameters().get("wiid");                                                                                                                                                                                                   
//      var sWI = jQuery.sap.getUriParameters().get("WI_ID")                                                                                                                                                                                                   
      var sWI = this._retrieveWI();                                                                                                                                                                                                                            
//      var dNewDate = this.getView().byId("newDeliveryDateId").getDateValue();                                                                                                                                                                                
      var dNewDate = this.getView().getBindingContext().getProperty("NewDeliveryDate");                                                                                                                                                                        
      if (dNewDate){                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
        var urlParam = {'NewDate':dNewDate,'WorkItemId':sWI};                                                                                                                                                                                                  
        this._pushData("/set_new_date", urlParam);                                                                                                                                                                                                             
      }                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
    },                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
    onFinalSave: function () {                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
//      var sWI = jQuery.sap.getUriParameters().get("wiid");                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
//      var sWI = jQuery.sap.getUriParameters().get("WI_ID")                                                                                                                                                                                                   
        var sWI = this._retrieveWI();                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
        var urlParam = {'WorkItemId':sWI};                                                                                                                                                                                                                     
        this._pushData("/set_final_delivery", urlParam);                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
    },                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
    onGrSave: function () {                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
      var bundle = this.getView().getModel("i18n").getResourceBundle();                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
//      var sWI = jQuery.sap.getUriParameters().get("wiid");                                                                                                                                                                                                   
//      var sWI = jQuery.sap.getUriParameters().get("WI_ID")                                                                                                                                                                                                   
      var sWI = this._retrieveWI();                                                                                                                                                                                                                            
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                           
      var oContext = this.getView().getBindingContext();                                                                                                                                                                                                       
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                           
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                           
      var sStorageLoc = "";                                                                                                                                                                                                                                    
      if ( oContext && this.getModel().getProperty("StorageLocation",this.getView().getBindingContext())){                                                                                                                                                     
    	sStorageLoc = this.getModel().getProperty("StorageLocation",this.getView().getBindingContext());                                                                                                                                                          
      }                                                                                                                                                                                                                                                        
      if ( oContext && this.getModel().getProperty("ItemType",this.getView().getBindingContext()) === '0' && sStorageLoc === ''){                                                                                                                              
      	MessageBox.error(bundle.getText("popupAction.ErrorMessageStorageLocationIsEmpty"));                                                                                                                                                                     
      	return;                                                                                                                                                                                                                                                 
      }                                                                                                                                                                                                                                                        
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                           
      var sQty = this.getView().byId("qtyToReceiptId").getValue();                                                                                                                                                                                             
      var sFinalDeliv = this.getView().byId("switchFinalDelivId").getState();                                                                                                                                                                                  
      if (sFinalDeliv === true){                                                                                                                                                                                                                               
        sFinalDeliv = 'X';                                                                                                                                                                                                                                     
      }else{                                                                                                                                                                                                                                                   
        sFinalDeliv = ' ';                                                                                                                                                                                                                                     
      }                                                                                                                                                                                                                                                        
      if (sQty ){                                                                                                                                                                                                                                              
        sQty = sQty.replace(/\s+/g, '');                                                                                                                                                                                                                       
        var sQtyRegex = /^[+-]?\d+(\.\d+)?$/;                                                                                                                                                                                                                  
          if (sQty.match(sQtyRegex)) {                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
        var urlParam = {'FinalDelivery':sFinalDeliv,'Quantity':sQty,'StorageLocation':sStorageLoc,'WorkItemId':sWI};                                                                                                                                           
        this._pushData("/set_gr", urlParam);                                                                                                                                                                                                                   
          }                                                                                                                                                                                                                                                    
          else{                                                                                                                                                                                                                                                
              MessageToast.show(bundle.getText("popupAction.ErrorMessageQtyType"));                                                                                                                                                                            
          }                                                                                                                                                                                                                                                    
      }                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
    },                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
    _pushData: function(funct, urlParam){                                                                                                                                                                                                                      
        var bundle = this.getView().getModel("i18n").getResourceBundle();                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
        var that = this;                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
        var param = {                                                                                                                                                                                                                                          
          method:"GET",                                                                                                                                                                                                                                        
          urlParameters:urlParam,                                                                                                                                                                                                                              
          success:function(oData,response){                                                                                                                                                                                                                    
            MessageToast.show(bundle.getText("popupAction.SuccessMessageToast"));                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                // Bind the view.                                                                                                                                                                                                                              
//            var sId = jQuery.sap.getUriParameters().get("wiid");                                                                                                                                                                                             
//            var sId = jQuery.sap.getUriParameters().get("WI_ID");                                                                                                                                                                                            
            var sId = that._retrieveWI();                                                                                                                                                                                                                      
            that._bindView(sId);                                                                                                                                                                                                                               
          },                                                                                                                                                                                                                                                   
          error:function(oError){                                                                                                                                                                                                                              
            MessageToast.show(bundle.getText("popupAction.ErrorMessageToast"));                                                                                                                                                                                
          }                                                                                                                                                                                                                                                    
        };                                                                                                                                                                                                                                                     
      this.getView().getModel().callFunction(funct, param);                                                                                                                                                                                                    
    },                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
    onExit : function () {                                                                                                                                                                                                                                     
      if (this._oPopover) {                                                                                                                                                                                                                                    
        this._oPopover.destroy();                                                                                                                                                                                                                              
      }                                                                                                                                                                                                                                                        
    },                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
    handleIconTabBarSelect: function(oEvent){                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
//      Initialise the newDeliveryDate                                                                                                                                                                                                                         
//      this.getView().byId("newDeliveryDateId").setDateValue(new Date());                                                                                                                                                                                     
    },                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
    handleSupplierPress : function (oEvent) {                                                                                                                                                                                                                  
      if (! this._oPopover) {                                                                                                                                                                                                                                  
        this._oPopover = sap.ui.xmlfragment("com.codilog.fragment.SupplPopover", this);                                                                                                                                                                        
        this._oPopover.setModel(this.getView().getModel());                                                                                                                                                                                                    
        this._oPopover.setModel(this.getView().getModel("i18n"), "i18n");                                                                                                                                                                                      
        this._oPopover.bindElement(oEvent.getSource().getBindingContext().getPath());                                                                                                                                                                          
      }                                                                                                                                                                                                                                                        
      this._oPopover.openBy(oEvent.getSource());                                                                                                                                                                                                               
      sap.ui.getCore().byId("supplierMapId").setSrc(this.buildMapPreview(oEvent.getSource().getBindingContext().getPath()));                                                                                                                                   
    },                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
    buildMapPreview : function (oContextPath){                                                                                                                                                                                                                 
      var sUrl = "http://maps.googleapis.com/maps/api/staticmap?center=";                                                                                                                                                                                      
      sUrl = sUrl + this.getView().getModel().getProperty(oContextPath+"/SuppHouseNum") + "+" +                                                                                                                                                                
                    this.getView().getModel().getProperty(oContextPath+"/SuppStreet") + "+" +&nbsp;                                                                                                                                                            
                    this.getView().getModel().getProperty(oContextPath+"/SuppPostCode") + "+" +&nbsp;                                                                                                                                                          
                    this.getView().getModel().getProperty(oContextPath+"/SuppCity");                                                                                                                                                                           
            sUrl = sUrl + "&zoom=12&scale=false&size=300x200&maptype=roadmap&format=png&visual_refresh=true&markers=size:mid%7Ccolor:0xff0000%7Clabel:1%7C10+boulevard+de+bapaume+Amiens";                                                                     
            return sUrl;                                                                                                                                                                                                                                       
    },                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
    handleTelPress: function (evt) {                                                                                                                                                                                                                           
      sap.m.URLHelper.triggerTel(evt.getSource().getText());                                                                                                                                                                                                   
    },                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
    handleMailPress: function (evt) {                                                                                                                                                                                                                          
      sap.m.URLHelper.triggerEmail(evt.getSource().getText());                                                                                                                                                                                                 
    },                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
    _retrieveWI: function(){                                                                                                                                                                                                                                   
      var sWI = "";                                                                                                                                                                                                                                            
      var oComponentData;                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
      sWI = jQuery.sap.getUriParameters().get("WI_ID");                                                                                                                                                                                                        
      if (!sWI || sWI === ""){                                                                                                                                                                                                                                 
        var sComponentId = sap.ui.core.Component.getOwnerIdFor(this.getView());                                                                                                                                                                                
        if (sComponentId){                                                                                                                                                                                                                                     
          oComponentData = sap.ui.component(sComponentId).getComponentData();                                                                                                                                                                                  
        }                                                                                                                                                                                                                                                      
        if (oComponentData ){                                                                                                                                                                                                                                  
           var aWI_ID = oComponentData.startupParameters["WI_ID"];                                                                                                                                                                                             
           if (aWI_ID.length > 0){                                                                                                                                                                                                                             
              sWI = aWI_ID[0];                                                                                                                                                                                                                                 
           }                                                                                                                                                                                                                                                   
        }                                                                                                                                                                                                                                                      
      }                                                                                                                                                                                                                                                        
      if(sWI && sWI.length >= 12){                                                                                                                                                                                                                             
        sWI = sWI.substr(0,12);                                                                                                                                                                                                                                
      }                                                                                                                                                                                                                                                        
      return sWI;                                                                                                                                                                                                                                              
    }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
  });                                                                                                                                                                                                                                                          
});                                                                                                                                                                                                                                                            